<!DOCTYPE html>
<html>
<head>
    <title>Hover Display Rich Text</title>
    <script src="https://cdn.jsdelivr.net/npm/turndown@7.0.0/dist/turndown.js"></script>
    <style>
        .truncated-text {
            position: relative;
            cursor: pointer;
        }

        .truncated-text::before {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0s linear 0.3s; /* Delay visibility change */
            max-width: 400px; /* Maximum width of the tooltip */
            max-height: 300px; /* Maximum height of the tooltip */
            overflow: auto; /* Add scroll to the tooltip */
            z-index: 9999; /* Set a high z-index to display above other elements */
        }

        .truncated-text:hover::before {
            content: attr(data-full-text);
            visibility: visible;
            opacity: 1;
        }

        .rich-text-popup {
            display: none;
            position: absolute;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 10px;
            z-index: 9999;
            max-width: 400px;
        }
    </style>
</head>
<body>
    {% for comment in comments %}
        <span
            class="truncated-text"
            data-full-text="{{ comment.text|safe }}"
            onmouseover="showFullText(this)"
            onmouseout="hideFullText()"
        >
            {{ comment.text|truncatechars:20 }}
        </span>
    {% endfor %}

    <div class="rich-text-popup" id="richTextPopup" contenteditable="true"></div>

    <!-- JavaScript code -->
    <script>
        var richTextPopup = document.getElementById("richTextPopup");
        var turndownService = new TurndownService();

        function showFullText(element) {
            var truncatedText = element;
            var fullText = truncatedText.getAttribute("data-full-text");

            // Set the position of the rich text popup
            var rect = truncatedText.getBoundingClientRect();
            richTextPopup.style.top = (rect.top + window.scrollY + 20) + "px";
            richTextPopup.style.left = (rect.left + window.scrollX) + "px";

            // Convert the HTML content to Markdown and display in the popup
            richTextPopup.innerHTML = turndownService.turndown(fullText);

            // Display the rich text popup
            richTextPopup.style.display = "block";
        }

        function hideFullText() {
            // Hide the rich text popup
            richTextPopup.style.display = "none";
        }

        // Hide the rich text popup if the mouse moves out of the current target element
        document.addEventListener("mousemove", function (event) {
            var popupRect = richTextPopup.getBoundingClientRect();
            if (
                event.clientX < popupRect.left ||
                event.clientX > popupRect.right ||
                event.clientY < popupRect.top ||
                event.clientY > popupRect.bottom
            ) {
                hideFullText();
            }
        });
    </script>
</body>
</html>
